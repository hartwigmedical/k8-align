#!/usr/bin/env bash

REPO_DIR_NAME="$(dirname "$0")" || exit 1

function printUsage(){
  echo "USAGE: $0 run"
  exit 1
}

function main() {
  if [ $# -lt 1 ]; then  # TODO: bump this back up if there are actual arguments
   printUsage
  fi

  CMD=$1 && shift
  case $CMD in
  run)
     run "$@"
     ;;
  version)
     version "$@"
     ;;
  *)
     printUsage
     ;;
  esac
}

function run() {
  pod_name="$(echo "k8-align-test" | awk '{print tolower($0)}')"
  clean_pod_name="$(echo "${pod_name}" | tr '_' '-' | tr '[:upper:]' '[:lower:]' | tr '.' '-')"
  docker_image="$(get_default_docker_image_at_k8)" || exit 1

  # Make sure correct credentials are available
  gcloud container clusters get-credentials rerun-cluster --region europe-west4 --project hmf-crunch || exit 1

  sed \
  -e "s/VAR_POD_NAME/${clean_pod_name}/g" \
  -e "s#DOCKER_IMAGE#${docker_image}#g" \
  "${REPO_DIR_NAME}/k8/hmf-crunch/deploy.yaml" \
  | kubectl create -f -  # use # as separator to handle / in docker image name
}

function version() {
  default_docker_image="$(get_default_docker_image_at_k8)" || exit 1
  echo "Current default Docker image version at k8: ${default_docker_image}"
}

function get_default_docker_image_at_k8() {
  cat "${REPO_DIR_NAME}/default_docker_image_at_k8.txt"
}

main "$@"